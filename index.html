<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat with Images</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; }
    #chat { display: none; margin-top: 1em; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: .5em; background: #fff; }
    #inputBox { margin-top: .5em; }
    img.msgImg { max-width: 200px; display: block; margin: 4px 0; }
    img.avatar { vertical-align: middle; border-radius: 50%; width: 24px; height: 24px; margin-right: 4px; }
  </style>
</head>
<body>
  <h2>Chat Demo</h2>
  <div id="login">
    <button id="googleBtn">Sign In with Google</button>
    <button id="anonBtn">Continue as Guest</button>
  </div>
  <div id="roomSelect" style="display:none;">
    <button id="randomBtn">Random Chat</button>
    <input id="roomCode" placeholder="Room Code">
    <button id="joinRoomBtn">Join Room</button>
  </div>
  <div id="chat">
    <h3 id="roomTitle"></h3>
    <div id="messages"></div>
    <div id="inputBox">
      <input id="msgInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
      <input type="file" id="imgInput" accept="image/*">
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { 
      getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { 
      getDatabase, ref, push, set, onChildAdded, update, get 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { 
      getStorage, ref as sRef, uploadBytes, getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    // âœ… Your config with databaseURL added
    const firebaseConfig = {
      apiKey: "AIzaSyCvxyd9Q37Zu4wMv-dGhcrom-En2Ja9n0o",
      authDomain: "chat-8c7f5.firebaseapp.com",
      databaseURL: "https://chat-8c7f5-default-rtdb.firebaseio.com",
      projectId: "chat-8c7f5",
      storageBucket: "chat-8c7f5.appspot.com",
      messagingSenderId: "566550384400",
      appId: "1:566550384400:web:6438e3fb134edfc6649f95",
      measurementId: "G-ZV55RSVRX6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // UI Elements
    const googleBtn = document.getElementById("googleBtn");
    const anonBtn = document.getElementById("anonBtn");
    const randomBtn = document.getElementById("randomBtn");
    const joinRoomBtn = document.getElementById("joinRoomBtn");
    const roomCodeInput = document.getElementById("roomCode");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const imgInput = document.getElementById("imgInput");
    const roomTitle = document.getElementById("roomTitle");

    let currentRoom = null;
    let user = null;

    // Sign in
    googleBtn.onclick = () => {
      signInWithPopup(auth, provider).catch(err => alert(err.message));
    };
    anonBtn.onclick = () => {
      signInAnonymously(auth);
    };

    onAuthStateChanged(auth, u => {
      if (u) {
        user = u;
        document.getElementById("login").style.display = "none";
        document.getElementById("roomSelect").style.display = "block";
      }
    });

    // Join group chat by code
    joinRoomBtn.onclick = () => {
      const code = roomCodeInput.value.trim();
      if (code) joinRoom("room_" + code);
    };

    // Random matchmaking
    randomBtn.onclick = async () => {
      const queueRef = ref(db, "queue");
      const snap = await get(queueRef);
      const queue = snap.val();
      let partner = null;
      if (queue) {
        for (let key in queue) {
          if (queue[key] !== user.uid) {
            partner = queue[key];
            await update(queueRef, { [key]: null });
            break;
          }
        }
      }
      if (partner) {
        const roomId = "match_" + [user.uid, partner].sort().join("_");
        joinRoom(roomId);
      } else {
        const newRef = push(queueRef);
        set(newRef, user.uid);
        alert("Waiting for a partner...");
      }
    };

    // Join room logic
    function joinRoom(roomId) {
      currentRoom = roomId;
      roomTitle.textContent = "Room: " + roomId;
      document.getElementById("roomSelect").style.display = "none";
      document.getElementById("chat").style.display = "block";
      messagesDiv.innerHTML = "";

      const msgRef = ref(db, "rooms/" + roomId);
      onChildAdded(msgRef, (snap) => {
        const msg = snap.val();
        const div = document.createElement("div");
        let prefix = msg.senderName || "Stranger";
        if (msg.sender === user.uid) prefix = "You";
        if (msg.photoURL) {
          const img = document.createElement("img");
          img.src = msg.photoURL;
          img.className = "avatar";
          div.appendChild(img);
        }
        if (msg.text) {
          div.appendChild(document.createTextNode(prefix + ": " + msg.text));
        }
        if (msg.imageUrl) {
          const image = document.createElement("img");
          image.src = msg.imageUrl;
          image.className = "msgImg";
          div.appendChild(image);
        }
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      sendBtn.onclick = () => {
        const text = msgInput.value.trim();
        if (!text) return;
        push(msgRef, { 
          sender: user.uid, 
          senderName: user.displayName || "Guest", 
          photoURL: user.photoURL || null, 
          text, 
          timestamp: Date.now() 
        });
        msgInput.value = "";
      };

      // Image upload
      imgInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const storageRef = sRef(storage, `rooms/${roomId}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        push(msgRef, { 
          sender: user.uid, 
          senderName: user.displayName || "Guest", 
          photoURL: user.photoURL || null, 
          imageUrl: url, 
          timestamp: Date.now() 
        });
        imgInput.value = "";
      };
    }
  </script>
</body>
</html>
